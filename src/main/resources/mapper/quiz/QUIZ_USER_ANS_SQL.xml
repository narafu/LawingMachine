<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.web.lawingmachine.app.training.mapper.QuizUserAnsMapper">

    <update id="mergeUserAnswer" useGeneratedKeys="true" keyProperty="quizUserAnsSeq">
        INSERT INTO QUIZ_USER_ANS (
        QUIZ_USER_ANS_SEQ
        , QUIZ_MSTR_INFO_SEQ
        , USER_ID
        , USER_ANSWER
        , ANSWER_CHK
        , USER_CHK_IMPRT
        , USER_CHK_CNFSD
        , REGIST_ID
        , REGIST_NM
        , REG_TS
        )
        VALUES (
        <choose>
            <when test="quizUserAnsSeq != null and quizUserAnsSeq != ''">
                #{quizUserAnsSeq}
            </when>
            <otherwise>
                (SELECT QUIZ_USER_ANS_SEQ FROM (SELECT IFNULL(MAX(QUIZ_USER_ANS_SEQ), 0) + 1 AS QUIZ_USER_ANS_SEQ FROM QUIZ_USER_ANS) X )
            </otherwise>
        </choose>
        , #{quizMstrInfoSeq}
        , #{userId}
        , #{userAnswer}
        , CASE WHEN (SELECT #{userAnswer} = (SELECT ANSWER FROM QUIZ_MSTR_INFO WHERE QUIZ_MSTR_INFO_SEQ =
        #{quizMstrInfoSeq})) = '1'
        THEN 'T' ELSE 'F' END
        , #{userChkImprt}
        , #{userChkCnfsd}
        , 'SYSTEM'
        , 'SYSTEM'
        , CURRENT_TIMESTAMP) ON
        DUPLICATE KEY
        UPDATE
        USER_ANSWER = #{userAnswer}
        , ANSWER_CHK = CASE WHEN (SELECT #{userAnswer} = (SELECT ANSWER FROM QUIZ_MSTR_INFO WHERE QUIZ_MSTR_INFO_SEQ =
        #{quizMstrInfoSeq})) = '1'
        THEN 'T' ELSE 'F' END
        , USER_CHK_IMPRT = #{userChkImprt}
        , USER_CHK_CNFSD = #{userChkCnfsd}
        , MDFY_TS = CURRENT_TIMESTAMP
    </update>

    <sql id="selectQuizResultRatioList-where">
        AND A.QUIZ_MSTR_INFO_SEQ = B.QUIZ_MSTR_INFO_SEQ
		AND A.DEL_YN = 'N'
        AND A.EXAM_GRP_CD = #{examGrpCd}
        AND A.EXAM_YEAR = #{examYear}
        AND A.EXAM_NO = #{examNo}
        <if test="schSubjectTypeCd != null and schSubjectTypeCd != ''">
            AND A.SUBJECT_TYPE_CD = #{schSubjectTypeCd}
        </if>
        <if test="schQuizCntnt != null and schQuizCntnt != ''">
            AND A.CONTENT LIKE '%' || #{schQuizCntnt} || '%'
        </if>
        <if test='schAnswerChk == "Y"'>
            AND B.ANSWER_CHK = 'F'
        </if>
        <if test='schUserChkCnfsd == "Y"'>
            AND B.USER_CHK_CNFSD = 'Y'
        </if>
        <if test='schUserChkImprt == "Y"'>
            AND B.USER_CHK_IMPRT = 'Y'
        </if>
    </sql>

    <select id="selectQuizResultRatioList" resultType="QuizMstrInfoVO">
        SELECT A.QUIZ_MSTR_INFO_SEQ
            , A.SUBJECT_TYPE_CD
            , A.EXAM_GRP_CD
            , A.EXAM_YEAR
            , A.EXAM_NO
            , B.ANSWER_CHK
            , B.USER_CHK_IMPRT
            , B.USER_CHK_CNFSD
            , SUM(CASE WHEN B.ANSWER_CHK = 'T' THEN 1 ELSE 0 END) / COUNT(*) AS QUIZ_TRUE_RATIO
        FROM QUIZ_MSTR_INFO A, QUIZ_USER_ANS B
        WHERE 1 = 1
        <include refid="selectQuizResultRatioList-where"></include>
        GROUP BY A.QUIZ_MSTR_INFO_SEQ
        ORDER BY A.QUIZ_MSTR_INFO_SEQ
    </select>

    <!--<select id="getQuizCntList" resultType="QuizMstrInfoVO">
        SELECT
        SUBJECT_TYPE_CD
        ,
        <include refid="util.getComnCodeNm">
            <property name="grpCd" value="001"/>
            <property name="grpDtlCd" value="A.SUBJECT_TYPE_CD"/>
            <property name="grpDtlNm" value="SUBJECT_TYPE_NM"/>
        </include>
        , COUNT(*) AS QUIZ_TOTAL_CNT
        , COUNT(CASE WHEN ANSWER_CHK = 'T' THEN 1 END) AS QUIZ_TRUE_CNT
        FROM QUIZ_MSTR_INFO A LEFT JOIN QUIZ_USER_ANS B
        ON A.QUIZ_MSTR_INFO_SEQ = B.QUIZ_MSTR_INFO_SEQ
        WHERE 1 = 1
        <include refid="selectQuizResultList-where"></include>
        GROUP BY SUBJECT_TYPE_CD
        ORDER BY SUBJECT_TYPE_CD, EXAM_YEAR, EXAM_GRP_CD, EXAM_NO
    </select>

    <select id="selectQuizUsrAnsSeqAll" resultType="HashMap">
        SELECT A.QUIZ_MSTR_INFO_SEQ AS quizMstrInfoSeq
             , B.QUIZ_USER_ANS_SEQ  AS quizUserAnsSeq
        FROM QUIZ_MSTR_INFO A
                 LEFT JOIN (SELECT * FROM QUIZ_USER_ANS WHERE USER_ID = #{userId}) B
                           ON A.QUIZ_MSTR_INFO_SEQ = B.QUIZ_MSTR_INFO_SEQ
        ORDER BY SUBJECT_TYPE_CD, SRT_NO
    </select>-->

</mapper>